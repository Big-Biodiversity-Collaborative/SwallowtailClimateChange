# Create a prediction script for each species from GLM
# Jeff Oliver
# jcoliver@arizona.edu
# 2021-06-02

# Read the file with organism names in as an array, skipping the header row 
# (hence -n +2 in call to tail)
readarray -t NAMES < <(tail -n +2 data/gbif-reconcile.csv)
# for testing on two lines
# readarray -t NAMES < <(tail -n +2 data/gbif-reconcile.csv | head -n 2)

# Iterate over all lines in that names file
for LINE in "${NAMES[@]}"
do
    # echo "$LINE"
    # Create an array out of that line
    IFS="," read -r -a ONENAME <<< "${LINE}"

    # Extract genus & species name
    GENUS=$(echo "${ONENAME[0]}" | sed 's/\"//g')
    SPECIES=$(echo "${ONENAME[1]}" | sed 's/\"//g')
    # echo "GENUS: ${GENUS}, SPECIES: ${SPECIES}"

    # For the filename, want genus to be lower case
    GENUSLOWER=$(echo $GENUS | tr '[:upper:]' '[:lower:]')
    FILENAME="scripts/${GENUSLOWER}_${SPECIES}-prediction-glm.R"
    
    # Read in the template file contents into the MODELFILE variable, 
    # skipping very first line
    MODELFILE=$(cat templates/template-prediction-glm-building.R | tail -n +2)

    # Add lines at top of file explaining script & message warning against 
    # editing
    MESSAGE="# This file is auto-generated by build-prediction-glm-files.sh. Do NOT edit."
    MODELFILE=$(echo -e "# Generate predicted distributions for ${GENUS} ${SPECIES} from GLM\n${MESSAGE}\n${MODELFILE}")

    # Use sed to find/replace GENUS/SPECIES values and write to file
    echo "${MODELFILE}" | \
      sed "s/GENUS/${GENUS}/g" | \
      sed "s/SPECIES/${SPECIES}/g" > "$FILENAME"
    echo "Wrote to ${FILENAME}"
done;
